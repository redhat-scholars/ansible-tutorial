<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Ansible Kubernetes :: Ansible Tutorial</title>
    <link rel="canonical" href="https://redhat-scholars.github.io/ansible-tutorial/ansible-tutorial/13-kubernetes.html">
    <link rel="prev" href="12-ansible-eda.html">
    <link rel="next" href="99-vagrant.html">
    <meta name="generator" content="Antora 3.0.0">
    <link rel="stylesheet" href="../_/css/site.css">
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://developers.redhat.com" target="_blank"><img src="../_/img/NewRHDFullLogo_4-color_white-wordmark.png" height="40px" alt="Red Hat Developer Program"></a>
      <a class="navbar-item" style="font-size: 24px; color: white" href="https://redhat-scholars.github.io/ansible-tutorial">Ansible Tutorial</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="https://developers.redhat.com/ebooks/" target="_blank">Books</a>
        <a class="navbar-item" href="https://developers.redhat.com/cheatsheets/" target="_blank">Cheat Sheets</a>
        <a class="navbar-item" href="https://developers.redhat.com/events/" target="_blank">Upcoming Events</a>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">More Tutorials</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/kubernetes-tutorial/" target="_blank">Kubernetes</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/istio-tutorial/" target="_blank">Istio</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/quarkus-tutorial/" target="_blank">Quarkus</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/knative-tutorial/" target="_blank">Knative</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/tekton-tutorial/" target="_blank">Tekton</a>
          </div>
        </div>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="ansible-tutorial" data-version="master">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="index.html"></a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">1. Requirements</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="01-setup.html#prerequisite">Prerequisites</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="01-setup.html#ansible">Setup Ansible</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="01-setup.html#downloadtutorial">Get Tutorial Sources</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="01-setup.html#preparingkeys">Preparing SSH keys</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="01-setup.html#bootingservers">Booting Servers</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">2. Ansible Beginner</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="02-getting-started.html">1. Getting Started</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="02-getting-started.html#ide">Editor</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="02-getting-started.html#inventory">Defining an Inventory</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="02-getting-started.html#runningansible">Running Ansible</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="02-getting-started.html#escalation">Privilege Escalation</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="02-getting-started.html#playbook">Playbooks</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="03-advanced.html">2. Templates</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="03-advanced.html#createtemplates">Create Templates</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="03-advanced.html#ansiblevault">Securing Files</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="04-roles.html">3. Roles</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="04-roles.html#firstrole">First Role</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="04-roles.html#handlers">Handlers</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="04-roles.html#sharingroles">Sharing Roles</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="04-roles.html#ansiblegalaxy">Ansible Galaxy</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">3. Ansible Elementary</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="10-setup.html">1. Requirements</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="10-setup.html#previousrequirements">Previous Requirements</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="10-setup.html#newprerequisite">Prerequisite</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="10-setup.html#setupansiblerulebook">Setup Ansible Rulebook</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="11-collections.html">2. Collections</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="11-collections.html#firstcollection">First Collection</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="11-collections.html#sharingollections">Sharing Collections</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="11-collections.html#collectionsansiblegalaxy">Ansible Galaxy and Collections</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="12-ansible-eda.html">3. Ansible EDA</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="12-ansible-eda.html#rulebookeda">Ansible Rulebook and EDA</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="12-ansible-eda.html#firstrulebook">First Rulebook</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="12-ansible-eda.html#executingplaybooksfromgit">Executing Playbooks stored at a Git repo</a>
  </li>
</ul>
  </li>
  <li class="nav-item is-current-page" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="13-kubernetes.html">4. Ansible and Kubernetes</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#ansiblekubernetes">Ansible Kubernetes Collection</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#deployapp">Deploy the application</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#ansibletemplatek8s">Ansible Templates in Kubernetes</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Appendix</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="99-vagrant.html">Vagrant</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="index.html">Ansible Tutorial</a></li>
    <li>3. Ansible Elementary</li>
    <li><a href="13-kubernetes.html">4. Ansible and Kubernetes</a></li>
  </ul>
</nav>
  <div class="edit-this-page"><a href="https://github.com/redhat-scholars/ansible-tutorial/edit/master/documentation/modules/ROOT/pages/13-kubernetes.adoc">Edit this Page</a></div>
  </div>
  <div class="content">
<article class="doc">
<h1 class="page">Ansible Kubernetes</h1>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>In this section, you&#8217;ll learn the following:</p>
</div>
<div class="ulist checklist">
<ul class="checklist">
<li>
<p><i class="fa fa-check-square-o"></i> How Ansible connects with Kubernetes</p>
</li>
<li>
<p><i class="fa fa-check-square-o"></i> Deploying Applications to Kubernetes using Ansible</p>
</li>
<li>
<p><i class="fa fa-check-square-o"></i> Using Ansible Templates as Kubernetes manifests</p>
</li>
<li>
<p><i class="fa fa-check-square-o"></i> Deleting Kubernetes Resources</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="ansiblekubernetes"><a class="anchor" href="#ansiblekubernetes"></a>Ansible and Kubernetes</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Ansible provides an <a href="https://docs.ansible.com/ansible/latest/collections/kubernetes/core/index.html">Ansible Kubernetes Collection</a> to interact with a Kubernetes cluster.
With these collections, you get the same approach of maintaining more traditional workloads like virtual machines, but for Kubernetes.</p>
</div>
<div class="paragraph">
<p>The first thing you need to do is create a Kubernetes cluster.
You can use any Kubernetes cluster you might have available (minikube, K3s, EKS, AKS, OpenShift, &#8230;&#8203;) but since there are many options we&#8217;ll focus on <a href="https://developers.redhat.com/developer-sandbox">Red Hat Developers Sandbox</a> a free cloud Kubernetes-OpenShift cluster ready to use, so no local installation is required.</p>
</div>
<div class="sect2">
<h3 id="_setup_red_hat_developer_sandbox"><a class="anchor" href="#_setup_red_hat_developer_sandbox"></a>Setup Red Hat Developer Sandbox</h3>
<div class="paragraph">
<p><a href="https://developers.redhat.com/developer-sandbox" target="_blank" rel="noopener">Developer Sandbox for Red Hat OpenShift</a> is a free Kubernetes cloud environment in a shared, multi-tenant OpenShift cluster that is pre-configured with a set of developer tools. The Developer Sandbox is active for 30 days and renewable once it expires.</p>
</div>
<div class="paragraph">
<p>To create your account, register to <a href="https://developers.redhat.com/developer-sandbox" target="_blank" rel="noopener">Developer Sandbox for Red Hat OpenShift</a>. From there, click on the red button that says <strong>Start your sandbox for free</strong> as shown in the following image.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="https://raw.githubusercontent.com/redhat-developer-demos/rhd-tutorial-common/main/images/devsandbox-signup.png" alt="Developer Sandbox Sign-up Page">
</div>
</div>
<div class="paragraph">
<p>Use your existing Red Hat account or create a new one, then follow the instructions on the screen. You should then be redirected to the Developer Sandbox page again, but this time, you should see a button labelled <strong>Start using your sandbox</strong>.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="https://raw.githubusercontent.com/redhat-developer-demos/rhd-tutorial-common/main/images/devsandbox-start.png" alt="Developer Sandbox Start Page">
</div>
</div>
<div class="paragraph">
<p>Clicking on it opens up the OpenShift login screen where you can log in using the <strong>DevSandbox</strong> button, as seen below.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="https://raw.githubusercontent.com/redhat-developer-demos/rhd-tutorial-common/main/images/devsandbox-login.png" alt="Log in the Developer Sandbox">
</div>
</div>
<div class="paragraph">
<p>Clicking this button opens up your new OpenShift cluster console.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="https://raw.githubusercontent.com/redhat-developer-demos/rhd-tutorial-common/main/images/devsandbox-topology-view.png" alt="Topology View">
</div>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Quotas and Limits</div>
<div class="paragraph">
<p>Your private OpenShift environment on Developer Sandbox includes quotas and limits of:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>7 GB RAM</p>
</li>
<li>
<p>15GB storage</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>which is enough to run this workshop.</p>
</div>
<div class="paragraph">
<p>There are one fixed project (namespace):</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>&lt;your_username&gt;-dev</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Please work in the <code>&lt;your_username&gt;-dev</code> project.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>After Kubernetes is up and running, we install the Kubernetes Collection.</p>
</div>
</div>
<div class="sect2">
<h3 id="_installing_ansible_kubernetes_collection"><a class="anchor" href="#_installing_ansible_kubernetes_collection"></a>Installing Ansible Kubernetes Collection</h3>
<div class="paragraph">
<p>First of all, we install the Kubernetes Python dependency:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">pip install kubernetes</code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
You must use <code>pip3</code> instead of <code>pip</code> depending on the environment and version.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Then let&#8217;s use Ansible Galaxy to install the collection:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">ansible-galaxy collection install kubernetes.core</code></pre>
</div>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">Starting galaxy collection install process
Process install dependency map
Starting collection install process
Downloading <a href="https://galaxy.ansible.com/download/kubernetes-core-2.4.0.tar.gz" class="bare">https://galaxy.ansible.com/download/kubernetes-core-2.4.0.tar.gz</a> to /Users/alexsoto/.ansible/tmp/ansible-local-561757k19pm6z/tmpkia3z432/kubernetes-core-2.4.0-e57tp6bs
Installing 'kubernetes.core:2.4.0' to '/Users/alexsoto/.ansible/collections/ansible_collections/kubernetes/core'
kubernetes.core:2.4.0 was installed successfully</code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
If you get a certificate verify failed exception, run the command with the <code>--ignore-certs</code> option.
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="deployapp"><a class="anchor" href="#deployapp"></a>Deploy Application to Kubernetes</h2>
<div class="sectionbody">
<div class="paragraph">
<p>To deploy the application, a login process is required.
The collection supports username/password method, <code>kubeconfig</code> folder, and also the authentication token.
For Red Hat Sandbox, we need to use the token approach to login into the cluster and interact with it.</p>
</div>
<div class="sect2">
<h3 id="_get_the_server_address_and_the_auth_token"><a class="anchor" href="#_get_the_server_address_and_the_auth_token"></a>Get the Server Address and the Auth Token</h3>
<div class="paragraph">
<p>Go to Sandbox main screen, click on your username placed at top-right position, and select the <code>Copy login command</code> option from the drop-down menu.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/sandbox-initial-topology.png" alt="sandbox initial topology">
</div>
</div>
<div class="paragraph">
<p>Then, copy the <code>token</code> and <code>server</code> properties in a temporal file, as we&#8217;ll need them later.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/sandbox-token.png" alt="sandbox token">
</div>
</div>
</div>
<div class="sect2">
<h3 id="_current_namespace"><a class="anchor" href="#_current_namespace"></a>Current Namespace</h3>
<div class="paragraph">
<p>Another important data to know is the working namespace Red Hat Sandbox has assigned to us.
It&#8217;s in the form of <code>&lt;username&gt;-dev</code>, and you can easily found it in the upper-left corner.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/sandbox-initial-topology-ns.png" alt="sandbox initial topology ns">
</div>
</div>
<div class="paragraph">
<p>This namespace is important too, as it&#8217;s where we&#8217;ll deploy the application.</p>
</div>
<div class="paragraph">
<p>With this information, let&#8217;s make Ansible deploy the application.</p>
</div>
</div>
<div class="sect2">
<h3 id="_deploy_to_kubernetes"><a class="anchor" href="#_deploy_to_kubernetes"></a>Deploy to Kubernetes</h3>
<div class="paragraph">
<p>Let&#8217;s start with a simple deployment of an already developed application.</p>
</div>
<div class="paragraph">
<p>In your working directory, create a new directory named <code>kubernetes</code>:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">mkdir kubernetes
cd kubernetes</code></pre>
</div>
</div>
<div class="paragraph">
<p>Create the <code>first-kubernetes-playbook.yaml</code> file containing the cluster information and the Kubernetes manifest information to deploy the application:</p>
</div>
<div class="listingblock console-input">
<div class="title">kubernetes/first-kubernetes-playbook.yaml</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">- name: Login
  hosts: localhost <i class="conum" data-value="1"></i><b>(1)</b>
  connection: local
  gather_facts: false
  environment:
    K8S_AUTH_HOST: "https://api.sandbox-m2.ll9k.p1.openshiftapps.com:6443" <i class="conum" data-value="2"></i><b>(2)</b>
    K8S_AUTH_API_KEY: "sha256~NRG7aBVOdaRonMJ172H16KrS0Chy--knwpefomLrcZA" <i class="conum" data-value="3"></i><b>(3)</b>
  tasks:
    - name: Deploy The Application
      kubernetes.core.k8s: <i class="conum" data-value="4"></i><b>(4)</b>
        state: present <i class="conum" data-value="5"></i><b>(5)</b>
        definition: <i class="conum" data-value="6"></i><b>(6)</b>
          apiVersion: apps/v1
          kind: Deployment
          metadata:
            namespace: asotobue-dev <i class="conum" data-value="7"></i><b>(7)</b>
            labels:
              app.kubernetes.io/name: hello-world
              app.kubernetes.io/version: 1.0.0-SNAPSHOT
            name: hello-world
          spec:
            replicas: 1
            selector:
              matchLabels:
                app.kubernetes.io/name: hello-world
                app.kubernetes.io/version: 1.0.0-SNAPSHOT
            template:
              metadata:
                labels:
                  app.kubernetes.io/name: hello-world
                  app.kubernetes.io/version: 1.0.0-SNAPSHOT
              spec:
                containers:
                  - env:
                      - name: KUBERNETES_NAMESPACE
                        valueFrom:
                          fieldRef:
                            fieldPath: metadata.namespace
                    image: quay.io/lordofthejars/hello-world:1.0.0-SNAPSHOT
                    imagePullPolicy: Always
                    name: hello-world
                    ports:
                      - containerPort: 8080
                        name: http
                        protocol: TCP</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The playbook is executed in the local machine</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Substitute the hostname with your <code>server</code> property</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Substitute the token with your <code>token</code> property</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Ansible Kubernetes Collection definition</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Apply the manifest</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Set the Kubernetes manifest content</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>Substitute the namespace with your current working namespace</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>After that, run the following command in the terminal to deploy the application to the Kubernetes cluster:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">ansible-playbook first-kubernetes-playbook.yaml</code></pre>
</div>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-terminal hljs" data-lang="terminal">[WARNING]: No inventory was parsed, only implicit localhost is available
[WARNING]: provided hosts list is empty, only localhost is available. Note that the implicit localhost does not match 'all'

PLAY [Login] ***************************************************************************************************************************************************************************************************************

TASK [Deploy The Application] **********************************************************************************************************************************************************************************************
changed: [localhost]

PLAY RECAP *****************************************************************************************************************************************************************************************************************
localhost                  : ok=1    changed=1    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0</code></pre>
</div>
</div>
<div class="paragraph">
<p>To validate the deployment, access the Red Hat Sandbox Topology view, and check that the application is there up and running:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/sandbox-first-deployment.png" alt="sandbox first deployment">
</div>
</div>
</div>
<div class="sect2">
<h3 id="_clean_up_the_namespace"><a class="anchor" href="#_clean_up_the_namespace"></a>Clean up the Namespace</h3>
<div class="paragraph">
<p>To clean up the namespace, we need to undeploy the application.</p>
</div>
<div class="paragraph">
<p>Create a <code>delete-kubernetes-playbook.yaml</code> file selecting which resource is deleted and setting the <code>state</code> to <code>Absent</code>.</p>
</div>
<div class="listingblock console-input">
<div class="title">kubernetes/delete-kubernetes-playbook.yaml</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">- name: Login
  hosts: localhost
  connection: local
  gather_facts: false
  environment:
    K8S_AUTH_HOST: "https://api.sandbox-m2.ll9k.p1.openshiftapps.com:6443" <i class="conum" data-value="1"></i><b>(1)</b>
    K8S_AUTH_API_KEY: "sha256~NRG7aBVOdaRonMJ172H16KrS0Chy--knwpefomLrcZA" #Â <i class="conum" data-value="2"></i><b>(2)</b>
  tasks:
    - name: Delete The Application
      kubernetes.core.k8s:
        state: absent <i class="conum" data-value="3"></i><b>(3)</b>
        api_version: v1
        kind: Deployment
        namespace: asotobue-dev <i class="conum" data-value="4"></i><b>(4)</b>
        name: hello-world <i class="conum" data-value="5"></i><b>(5)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Substitute the hostname with your <code>server</code> property</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Substitute the token with your <code>token</code> property</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Delete the resource</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Substitute the namespace with your current working namespace</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Name of the deployment</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>After that, run the following command in the terminal to undeploy the application from the Kubernetes cluster:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">ansible-playbook delete-kubernetes-playbook.yaml</code></pre>
</div>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-terminal hljs" data-lang="terminal">[WARNING]: No inventory was parsed, only implicit localhost is available
[WARNING]: provided hosts list is empty, only localhost is available. Note that the implicit localhost does not match 'all'

PLAY [Login] ***************************************************************************************************************************************************************************************************************

TASK [Delete The Application] **********************************************************************************************************************************************************************************************
changed: [localhost]

PLAY RECAP *****************************************************************************************************************************************************************************************************************
localhost                  : ok=1    changed=1    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_referencing_kubernetes_manifest_files"><a class="anchor" href="#_referencing_kubernetes_manifest_files"></a>Referencing Kubernetes manifest files</h3>
<div class="paragraph">
<p>In the previous example, we defined the Kubernetes manifest within the playbook.
Although this is possible and it has some advantages, most of the time, you&#8217;ll define the resources outside of the playbook.
Ansible Kubernetes collection let you reference external Kubernetes files directly in the playbook.</p>
</div>
<div class="paragraph">
<p>Create a Kubernetes Deployment file named <code>deployment.yaml</code> in <code>kubernetes</code> directory with the following content:</p>
</div>
<div class="listingblock console-input">
<div class="title">kubernetes/deployment.yaml</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">---
apiVersion: apps/v1
kind: Deployment
metadata:
  namespace: asotobue-dev <i class="conum" data-value="1"></i><b>(1)</b>
  labels:
    app.kubernetes.io/name: hello-world
    app.kubernetes.io/version: 1.0.0-SNAPSHOT
  name: hello-world
spec:
  replicas: 1
  selector:
    matchLabels:
      app.kubernetes.io/name: hello-world
      app.kubernetes.io/version: 1.0.0-SNAPSHOT
  template:
    metadata:
      labels:
        app.kubernetes.io/name: hello-world
        app.kubernetes.io/version: 1.0.0-SNAPSHOT
    spec:
      containers:
        - env:
            - name: KUBERNETES_NAMESPACE
              valueFrom:
                fieldRef:
                  fieldPath: metadata.namespace
          image: quay.io/lordofthejars/hello-world:1.0.0-SNAPSHOT
          imagePullPolicy: Always
          name: hello-world
          ports:
            - containerPort: 8080
              name: http
              protocol: TCP
---
apiVersion: v1
kind: Service
metadata:
  namespace: asotobue-dev <i class="conum" data-value="2"></i><b>(2)</b>
  annotations:
    app.quarkus.io/commit-id: 277270f3f2a7b0e78c69b3be83be372c7e6ca693
    app.quarkus.io/build-timestamp: 2023-03-08 - 08:51:15 +0000
  labels:
    app.kubernetes.io/name: hello-world
    app.kubernetes.io/version: 1.0.0-SNAPSHOT
  name: hello-world
spec:
  ports:
    - name: http
      port: 80
      protocol: TCP
      targetPort: 8080
  selector:
    app.kubernetes.io/name: hello-world
    app.kubernetes.io/version: 1.0.0-SNAPSHOT
  type: ClusterIP</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Substitute the namespace with your current working namespace</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Substitute the namespace with your current working namespace</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Then, create the <code>file-kubernetes-playbook.yaml</code> file referencing this manifest instead of defining it on the playbook.</p>
</div>
<div class="listingblock console-input">
<div class="title">kubernetes/file-kubernetes-playbook.yaml</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">- name: Login
  hosts: localhost
  connection: local
  gather_facts: false
  environment:
    K8S_AUTH_HOST: "https://api.sandbox-m2.ll9k.p1.openshiftapps.com:6443" <i class="conum" data-value="1"></i><b>(1)</b>
    K8S_AUTH_API_KEY: "sha256~NRG7aBVOdaRonMJ172H16KrS0Chy--knwpefomLrcZA" <i class="conum" data-value="2"></i><b>(2)</b>
  tasks:
    - name: Deploy The Application
      kubernetes.core.k8s:
        state: present
        src: deployment.yaml <i class="conum" data-value="3"></i><b>(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Substitute the hostname with your <code>server</code> property</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Substitute the token with your <code>token</code> property</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Set the location of the Kubernetes manifest to apply</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>After that, run the following command in the terminal to undeploy the application from the Kubernetes cluster:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">ansible-playbook file-kubernetes-playbook.yaml</code></pre>
</div>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-terminal hljs" data-lang="terminal">[WARNING]: No inventory was parsed, only implicit localhost is available
[WARNING]: provided hosts list is empty, only localhost is available. Note that the implicit localhost does not match 'all'

PLAY [Login] ***************************************************************************************************************************************************************************************************************

TASK [Deploy The Application] **********************************************************************************************************************************************************************************************
changed: [localhost]

PLAY RECAP *****************************************************************************************************************************************************************************************************************
localhost                  : ok=1    changed=1    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0</code></pre>
</div>
</div>
<div class="paragraph">
<p>Check the application is running in the Red Hat Sandbox Topology view:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/sandbox-file-deployment.png" alt="sandbox file deployment">
</div>
</div>
</div>
<div class="sect2">
<h3 id="_clean_up"><a class="anchor" href="#_clean_up"></a>Clean up</h3>
<div class="paragraph">
<p>To cleanup the namespace, create the <code>delete-all-kubernetes-playbook.yaml</code>:</p>
</div>
<div class="listingblock console-input">
<div class="title">kubernetes/delete-all-kubernetes-playbook.yaml</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">- name: Login
  hosts: localhost
  connection: local
  gather_facts: false
  environment:
    K8S_AUTH_HOST: "https://api.sandbox-m2.ll9k.p1.openshiftapps.com:6443" <i class="conum" data-value="1"></i><b>(1)</b>
    K8S_AUTH_API_KEY: "sha256~NRG7aBVOdaRonMJ172H16KrS0Chy--knwpefomLrcZA" <i class="conum" data-value="2"></i><b>(2)</b>
  tasks:
    - name: Delete The Application
      kubernetes.core.k8s:
        state: absent
        api_version: v1
        kind: Deployment
        namespace: asotobue-dev <i class="conum" data-value="3"></i><b>(3)</b>
        name: hello-world
    - name: Delete The Service
      kubernetes.core.k8s:
        state: absent
        api_version: v1
        kind: Service
        namespace: asotobue-dev <i class="conum" data-value="4"></i><b>(4)</b>
        name: hello-world</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Substitute the hostname with your <code>server</code> property</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Substitute the token with your <code>token</code> property</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Substitute the namespace with your current working namespace</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Substitute the namespace with your current working namespace</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>And run the playbook:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">ansible-playbook delete-all-kubernetes-playbook.yaml</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="ansibletemplatek8s"><a class="anchor" href="#ansibletemplatek8s"></a>Ansible Templates as Kubernetes manifests</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Ansible Kubernetes Collection also integrates with Ansible templates, so you can define Kubernetes manifests as templates.</p>
</div>
<div class="paragraph">
<p>Create a <code>deployment.j2</code> file in the <code>kubernetes</code> folder:</p>
</div>
<div class="listingblock console-input">
<div class="title">kubernetes/deployment.j2</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">---
apiVersion: apps/v1
kind: Deployment
metadata:
  namespace: asotobue-dev <i class="conum" data-value="1"></i><b>(1)</b>
  labels:
    app.kubernetes.io/name: hello-world
    app.kubernetes.io/version: {{ version }} <i class="conum" data-value="2"></i><b>(2)</b>
  name: hello-world
spec:
  replicas: 1
  selector:
    matchLabels:
      app.kubernetes.io/name: hello-world
      app.kubernetes.io/version: {{ version }}
  template:
    metadata:
      labels:
        app.kubernetes.io/name: hello-world
        app.kubernetes.io/version: {{ version }}
    spec:
      containers:
        - env:
            - name: KUBERNETES_NAMESPACE
              valueFrom:
                fieldRef:
                  fieldPath: metadata.namespace
          image: quay.io/lordofthejars/hello-world:{{ version }}
          imagePullPolicy: Always
          name: hello-world
          ports:
            - containerPort: 8080
              name: http
              protocol: TCP</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Substitute the namespace with your current working namespace</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Template placeholder</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Then, create the <code>template-kubernetes-playbook.yaml</code> file:</p>
</div>
<div class="listingblock console-input">
<div class="title">kubernetes/template-kubernetes-playbook.yaml</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">- name: Login
  hosts: localhost
  connection: local
  gather_facts: false
  vars:
    - version: 1.0.0-SNAPSHOT <i class="conum" data-value="1"></i><b>(1)</b>
  environment:
    K8S_AUTH_HOST: "https://api.sandbox-m2.ll9k.p1.openshiftapps.com:6443" <i class="conum" data-value="2"></i><b>(2)</b>
    K8S_AUTH_API_KEY: "sha256~NRG7aBVOdaRonMJ172H16KrS0Chy--knwpefomLrcZA" <i class="conum" data-value="3"></i><b>(3)</b>
  tasks:
    - name: Deploy The Application
      kubernetes.core.k8s:
        state: present
        template: deployment.j2 <i class="conum" data-value="4"></i><b>(4)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Set <code>version</code> for the placeholder</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Substitute the hostname with your <code>server</code> property</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Substitute the token with your <code>token</code> property</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Set the template location</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Run the playbook:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">ansible-playbook template-kubernetes-playbook.yaml</code></pre>
</div>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-terminal hljs" data-lang="terminal">[WARNING]: No inventory was parsed, only implicit localhost is available
[WARNING]: provided hosts list is empty, only localhost is available. Note that the implicit localhost does not match 'all'

PLAY [Login] ***************************************************************************************************************************************************************************************************************

TASK [Deploy The Application] **********************************************************************************************************************************************************************************************
changed: [localhost]

PLAY RECAP *****************************************************************************************************************************************************************************************************************
localhost                  : ok=1    changed=1    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0</code></pre>
</div>
</div>
<div class="paragraph">
<p>Check the application is running in the Red Hat Sandbox Topology view:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/sandbox-template-result.png" alt="sandbox template result">
</div>
</div>
</div>
</div>
<nav class="pagination">
  <span class="prev"><a href="12-ansible-eda.html">3. Ansible EDA</a></span>
  <span class="next"><a href="99-vagrant.html">Vagrant</a></span>
</nav>
</article>
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
  </div>
</main>
</div>
<footer class="footer">
  <a class="rhd-logo" href="https://developers.redhat.com" target="_blank"></div>
</footer>
<script src="../_/js/vendor/clipboard.js"></script>
<script src="../_/js/site.js"></script>
<script async src="../_/js/vendor/highlight.js"></script>
  </body>
</html>
