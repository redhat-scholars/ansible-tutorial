<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Getting Started :: Ansible Tutorial</title>
    <link rel="canonical" href="https://redhat-scholars.github.io/ansible-tutorial/ansible-tutorial/02-getting-started.html">
    <link rel="prev" href="01-setup.html#prerequisite">
    <link rel="next" href="03-advanced.html">
    <meta name="generator" content="Antora 3.0.0">
    <link rel="stylesheet" href="../_/css/site.css">
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://developers.redhat.com" target="_blank"><img src="../_/img/NewRHDFullLogo_4-color_white-wordmark.png" height="40px" alt="Red Hat Developer Program"></a>
      <a class="navbar-item" style="font-size: 24px; color: white" href="https://redhat-scholars.github.io/ansible-tutorial">Ansible Tutorial</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="https://developers.redhat.com/ebooks/" target="_blank">Books</a>
        <a class="navbar-item" href="https://developers.redhat.com/cheatsheets/" target="_blank">Cheat Sheets</a>
        <a class="navbar-item" href="https://developers.redhat.com/events/" target="_blank">Upcoming Events</a>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">More Tutorials</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/kubernetes-tutorial/" target="_blank">Kubernetes</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/istio-tutorial/" target="_blank">Istio</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/quarkus-tutorial/" target="_blank">Quarkus</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/knative-tutorial/" target="_blank">Knative</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/tekton-tutorial/" target="_blank">Tekton</a>
          </div>
        </div>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="ansible-tutorial" data-version="master">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="index.html"></a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">1. Requirements</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="01-setup.html#prerequisite">Prerequisites</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="01-setup.html#ansible">Setup Ansible</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="01-setup.html#downloadtutorial">Get Tutorial Sources</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="01-setup.html#preparingkeys">Preparing SSH keys</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="01-setup.html#bootingservers">Booting Servers</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">2. Ansible Beginner</span>
<ul class="nav-list">
  <li class="nav-item is-current-page" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="02-getting-started.html">1. Getting Started</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#ide">Editor</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#inventory">Defining an Inventory</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#runningansible">Running Ansible</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#escalation">Privilege Escalation</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#playbook">Playbooks</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="03-advanced.html">2. Templates</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="03-advanced.html#createtemplates">Create Templates</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="03-advanced.html#ansiblevault">Securing Files</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="04-roles.html">3. Roles</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="04-roles.html#firstrole">First Role</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="04-roles.html#handlers">Handlers</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="04-roles.html#sharingroles">Sharing Roles</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="04-roles.html#ansiblegalaxy">Ansible Galaxy</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">3. Ansible Elementary</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="10-setup.html">1. Requirements</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="10-setup.html#previousrequirements">Previous Requirements</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="10-setup.html#newprerequisite">Prerequisite</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="10-setup.html#setupansiblerulebook">Setup Ansible Rulebook</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="11-collections.html">2. Collections</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="11-collections.html#firstcollection">First Collection</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="11-collections.html#sharingollections">Sharing Collections</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="11-collections.html#collectionsansiblegalaxy">Ansible Galaxy and Collections</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="12-ansible-eda.html">3. Ansible EDA</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="12-ansible-eda.html#rulebookeda">Ansible Rulebook and EDA</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="12-ansible-eda.html#firstrulebook">First Rulebook</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="12-ansible-eda.html#executingplaybooksfromgit">Executing Playbooks stored at a Git repo</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="13-kubernetes.html">4. Ansible and Kubernetes</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="13-kubernetes.html#ansiblekubernetes">Ansible Kubernetes Collection</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="13-kubernetes.html#deployapp">Deploy the application</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="13-kubernetes.html#ansibletemplatek8s">Ansible Templates in Kubernetes</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Appendix</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="99-vagrant.html">Vagrant</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="index.html">Ansible Tutorial</a></li>
    <li>2. Ansible Beginner</li>
    <li><a href="02-getting-started.html">1. Getting Started</a></li>
  </ul>
</nav>
  <div class="edit-this-page"><a href="https://github.com/redhat-scholars/ansible-tutorial/edit/master/documentation/modules/ROOT/pages/02-getting-started.adoc">Edit this Page</a></div>
  </div>
  <div class="content">
<article class="doc">
<h1 class="page">Getting Started</h1>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>In this section, you&#8217;ll learn the following:</p>
</div>
<div class="ulist checklist">
<ul class="checklist">
<li>
<p><i class="fa fa-check-square-o"></i> Create an Ansible inventory file</p>
</li>
<li>
<p><i class="fa fa-check-square-o"></i> Run Ansible with basic modules</p>
</li>
<li>
<p><i class="fa fa-check-square-o"></i> Executing commands in the remote host</p>
</li>
<li>
<p><i class="fa fa-check-square-o"></i> Installing packages to the remote host</p>
</li>
<li>
<p><i class="fa fa-check-square-o"></i> Create a Playbook file</p>
</li>
<li>
<p><i class="fa fa-check-square-o"></i> Copying files from the local host to the remote host</p>
</li>
<li>
<p><i class="fa fa-check-square-o"></i> Installing a Quarkus application (with its dependencies) into the remote host</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>With machines up and running and Ansible installed, we can start managing the infrastructure.</p>
</div>
<div class="paragraph">
<p>Go to the directory where you cloned the Ansible tutorial repository, and create a new directory to store the Ansible code:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">mkdir app1
cd app1</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="ide"><a class="anchor" href="#ide"></a>IDE</h2>
<div class="sectionbody">
<div class="paragraph">
<p>You can use any editor to create Ansible files, but we&#8217;d recommend you use Visual Studio Code with the Ansible language support extension:</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="_images/ansibleide.png" alt="ansibleide"></span></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="inventory"><a class="anchor" href="#inventory"></a>Inventory</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The first thing is creating an <code>inventory</code> file.
Ansible automates tasks on managed nodes or "hosts" in your infrastructure using a list or group of lists of hosts.
This is known as an inventory file.
Although this inventory file is now static, Ansible also supports getting hosts from dynamic resources like Cobbler or OpenStack.</p>
</div>
<div class="paragraph">
<p>The inventory file can be created in <em>YAML</em> or <em>INI</em> format.
In this example <em>INI</em> format is used as it&#8217;s easy to understand and less error-prone to white spaces.</p>
</div>
<div class="paragraph">
<p>So, let&#8217;s create the inventory file for managing two servers grouped in two categories (<code>staging</code> and <code>production</code>):</p>
</div>
<div class="paragraph">
<p>Create a new file named <code>inventory</code> with the following content:</p>
</div>
<div class="listingblock console-input">
<div class="title">inventory</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-ini hljs" data-lang="ini">[staging]
staging ansible_user=root ansible_host=127.0.0.1 ansible_port=2223 ansible_ssh_private_key_file=~/.ssh/id_rsa_ansible

[production]
production ansible_user=root ansible_host=127.0.0.1 ansible_port=2224 ansible_ssh_private_key_file=~/.ssh/id_rsa_ansible</code></pre>
</div>
</div>
<div class="paragraph">
<p>In this inventory file, we set two groups of servers, one for the staging and another for the production environments.</p>
</div>
<div class="paragraph">
<p>For each entry, we set the user to login, the hostname/IP, the SSH port, and
the private key to use.</p>
</div>
<div class="paragraph">
<p>Run the following command to list the inventory:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">ansible-inventory -i inventory --list</code></pre>
</div>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-terminal hljs" data-lang="terminal">[WARNING]: Found both group and host with same name: production
[WARNING]: Found both group and host with same name: staging
{
    "_meta": {
        "hostvars": {
            "production": {
                "ansible_host": "127.0.0.1",
                "ansible_port": 2224,
                "ansible_ssh_private_key_file": "~/.ssh/id_rsa_ansible",
                "ansible_user": "root"
            },
            "staging": {
                "ansible_host": "127.0.0.1",
                "ansible_port": 2223,
                "ansible_ssh_private_key_file": "~/.ssh/id_rsa_ansible",
                "ansible_user": "root"
            }
        }
    },
    "all": {
        "children": [
            "production",
            "staging",
            "ungrouped"
        ]
    },
    "production": {
        "hosts": [
            "production"
        ]
    },
    "staging": {
        "hosts": [
            "staging"
        ]
    }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="runningansible"><a class="anchor" href="#runningansible"></a>Running Ansible</h2>
<div class="sectionbody">
<div class="paragraph">
<p>One of the essential parts of Ansible is <strong>Modules</strong>, which are portions of code executed from Ansible, usually on the remote target node (using the SSH connection), and collects return values.</p>
</div>
<div class="paragraph">
<p>An example of a module is the <strong>ping</strong> module.
This module contains the code to execute a ping against servers.</p>
</div>
<div class="paragraph">
<p>In the same way, there is a module to copy files from a local directory to the remote server.</p>
</div>
<div class="paragraph">
<p>Of course, you could implement them by running commands/shell scripts, but Ansible provides these modules.</p>
</div>
<div class="sect2">
<h3 id="modulecli"><a class="anchor" href="#modulecli"></a>Ping module</h3>
<div class="paragraph">
<p>Let&#8217;s use Ansible to ping all servers defined in the inventory.
Run the following command in the same directory where you created the <code>inventory</code> file to ping <strong>staging</strong> servers.</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">ansible staging -i inventory -m ping <i class="conum" data-value="1"></i><b>(1)</b> <i class="conum" data-value="2"></i><b>(2)</b> <i class="conum" data-value="3"></i><b>(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>First argument is the group of servers to execute the command</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>With <code>-i</code> you set the inventory file location</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>With <code>-m</code> enables the ping module</td>
</tr>
</table>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-terminal hljs" data-lang="terminal">[WARNING]: Found both group and host with same name: staging
[WARNING]: Found both group and host with same name: production
staging | SUCCESS =&gt; {
    "ansible_facts": {
        "discovered_interpreter_python": "/usr/bin/python3"
    },
    "changed": false,
    "ping": "pong"
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Same can be done with <strong>production</strong> servers:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">ansible production -i inventory -m ping</code></pre>
</div>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-terminal hljs" data-lang="terminal">[WARNING]: Found both group and host with same name: production
[WARNING]: Found both group and host with same name: staging
production | SUCCESS =&gt; {
    "ansible_facts": {
        "discovered_interpreter_python": "/usr/bin/python3"
    },
    "changed": false,
    "ping": "pong"
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can also use the IP/hostname of the server or the particular keyword <code>all directly</code> to execute it to all servers defined in the inventory file.</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">ansible all -i inventory -m ping</code></pre>
</div>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-terminal hljs" data-lang="terminal">[WARNING]: Found both group and host with same name: production
[WARNING]: Found both group and host with same name: staging
staging | SUCCESS =&gt; {
    "ansible_facts": {
        "discovered_interpreter_python": "/usr/bin/python3"
    },
    "changed": false,
    "ping": "pong"
}
production | SUCCESS =&gt; {
    "ansible_facts": {
        "discovered_interpreter_python": "/usr/bin/python3"
    },
    "changed": false,
    "ping": "pong"
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="modulecommand"><a class="anchor" href="#modulecommand"></a>Command module</h3>
<div class="paragraph">
<p>Sometimes we only want to execute a command against servers, so we do not rely on any module but send the command directly through an SSH connection.
For these cases, there is the command module.
Let&#8217;s run the <code>uptime</code> command inside all servers defined in the inventory.</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">ansible all -i inventory -a "uptime" <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>With <code>-a</code> option you run directly the command to servers</td>
</tr>
</table>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-terminal hljs" data-lang="terminal">[WARNING]: Found both group and host with same name: production
[WARNING]: Found both group and host with same name: staging
production | FAILED | rc=2 &gt;&gt;
[Errno 2] No such file or directory: b'uptime'
staging | FAILED | rc=2 &gt;&gt;
[Errno 2] No such file or directory: b'uptime'</code></pre>
</div>
</div>
<div class="paragraph">
<p>The uptime command is not present in the servers, so Ansible gets back the error message.
Let&#8217;s install the <code>uptime</code> program on all servers to fix this problem.
Since servers are a Fedora distribution, we use the <code>dnf</code> module to install the package.</p>
</div>
<div class="paragraph">
<p>INFO: <code>uptime</code> program is inside the <code>procps-ng</code> package.</p>
</div>
<div class="paragraph">
<p>Run the following command to run <code>dnf</code> to all servers with the <code>name</code> argument set to <code>procps-ng</code>:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">ansible all -i inventory -m dnf -a "name=procps-ng"</code></pre>
</div>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-terminal hljs" data-lang="terminal">[WARNING]: Found both group and host with same name: production
[WARNING]: Found both group and host with same name: staging
production | CHANGED =&gt; {
    "ansible_facts": {
        "discovered_interpreter_python": "/usr/bin/python3"
    },
    "changed": true,
    "msg": "",
    "rc": 0,
    "results": [
        "Installed: procps-ng-3.3.17-6.fc37.2.x86_64"
    ]
}
staging | CHANGED =&gt; {
    "ansible_facts": {
        "discovered_interpreter_python": "/usr/bin/python3"
    },
    "changed": true,
    "msg": "",
    "rc": 0,
    "results": [
        "Installed: procps-ng-3.3.17-6.fc37.2.x86_64"
    ]
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Run again the <code>uptime</code> command to verify it&#8217;s installed.</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">ansible all -i inventory -a "uptime"</code></pre>
</div>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-terminal hljs" data-lang="terminal">[WARNING]: Found both group and host with same name: production
[WARNING]: Found both group and host with same name: staging
production | CHANGED | rc=0 &gt;&gt;
 13:44:23 up  2:39,  0 users,  load average: 0.12, 0.09, 0.04
staging | CHANGED | rc=0 &gt;&gt;
 13:44:23 up  2:39,  0 users,  load average: 0.12, 0.09, 0.04</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="escalation"><a class="anchor" href="#escalation"></a>Privilege Escalation</h2>
<div class="sectionbody">
<div class="paragraph">
<p>For simplicity, we are login into the machines as the root user.
This lets you access protected resources.
To validate the <code>dnf</code> log, we can run the following:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">ansible staging -i inventory -a "cat /var/log/dnf.log"</code></pre>
</div>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-terminal hljs" data-lang="terminal">[WARNING]: Found both group and host with same name: staging
[WARNING]: Found both group and host with same name: production
staging | CHANGED | rc=0 &gt;&gt;
2023-01-16T17:32:49+0000 INFO --- logging initialized ---
2023-01-16T17:32:49+0000 DDEBUG timer: config: 7 ms
2023-01-16T17:32:49+0000 DEBUG YUM version: 4.14.0
2023-01-16T17:32:49+0000 DDEBUG Command: yum -y update
2023-01-16T17:32:49+0000 DDEBUG Installroot: /
2023-01-16T17:32:49+0000 DDEBUG Releasever: 37</code></pre>
</div>
</div>
<div class="paragraph">
<p>This case works because we&#8217;re already root, but logging with a non-root user might need some privilege escalation to execute the command.</p>
</div>
<div class="paragraph">
<p>Ansible offers several arguments for that escalation, but the most used are <code>--become</code> and <code>-K</code>.</p>
</div>
<div class="paragraph">
<p>The <code>--become</code> argument is used to run the operations with a privilege escalation. By default, it&#8217;s <code>sudo</code>, but it could be <code>su</code>, <code>pbrun</code>, &#8230;&#8203;</p>
</div>
<div class="paragraph">
<p>The <code>-K</code> argument is used to ask for a privilege escalation password.</p>
</div>
<div class="paragraph">
<p>So in case of not being a root user, the previous command should be:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">ansible staging --become -K -i inventory -a "cat /var/log/dnf.log"</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="playbook"><a class="anchor" href="#playbook"></a>Playbooks</h2>
<div class="sectionbody">
<div class="paragraph">
<p>So far, we&#8217;ve seen running commands against a list of servers using Ansible, and this might be good when the command is simple.
But what happens when we need to run a list of operations against the servers, for example, installing the Java Virtual Machine, copying our application files into the servers, and starting it?</p>
</div>
<div class="paragraph">
<p>One option could be manually running the <code>ansible</code> command several times in the terminal.
But Ansible offers a way to define all these instructions/steps/tasks in a single file and apply them to all inventory elements.
This file in Ansible is named a <strong>playbook</strong>.</p>
</div>
<div class="paragraph">
<p>A playbook is a YAML file where we configure all these execution steps.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s see a complete example of preparing, installing, and running a Java application into each of the servers defined in the inventory.</p>
</div>
<div class="sect2">
<h3 id="firstplaybook"><a class="anchor" href="#firstplaybook"></a>Prepare Environments</h3>
<div class="paragraph">
<p>The first part of our playbook is composed of installing the Java Virtual Machine and creating the directory where the application will be copied.</p>
</div>
<div class="paragraph">
<p>To do that, <code>dnf</code> and <code>file</code> modules are used.
Create a new file named <code>playbook.yaml</code> in the same directory as the inventory with the following content:</p>
</div>
<div class="listingblock console-input">
<div class="title">playbook.yaml</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">---
- hosts: all <i class="conum" data-value="1"></i><b>(1)</b>
  become: true <i class="conum" data-value="2"></i><b>(2)</b>
  tasks:
    - name: Install Packages
      dnf: name={{ item }} <i class="conum" data-value="3"></i><b>(3)</b>
      loop: [ 'java-17-openjdk-devel'] <i class="conum" data-value="4"></i><b>(4)</b>
      tags: [ 'setup' ]
    - name: Create a directory if it does not exist
      file: <i class="conum" data-value="5"></i><b>(5)</b>
        path: /var/hello <i class="conum" data-value="6"></i><b>(6)</b>
        state: directory
        mode: '0755'
      tags: ['setup']</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Apply all tasks to all machines defined in the inventory file</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Execute commands with <code>sudo</code></td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Run <code>dnf</code> against the value of the variable item</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Loops through the array of elements, setting them in the <code>item</code> var and executing <code>dnf</code></td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Use the <code>file</code> module to create a directory</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Creates <code>/var/hello</code> directory in all machines</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>To apply a Playbook, run the following command:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">ansible-playbook -i inventory playbook.yaml</code></pre>
</div>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-terminal hljs" data-lang="terminal">[WARNING]: Found both group and host with same name: staging
[WARNING]: Found both group and host with same name: production

PLAY [all] *********************************************************************

TASK [Gathering Facts] *********************************************************
ok: [production]
ok: [staging]

TASK [Install Packages] ********************************************************
changed: [production] =&gt; (item=java-17-openjdk-devel)
changed: [staging] =&gt; (item=java-17-openjdk-devel)

TASK [Create a directory if it does not exist] *********************************
changed: [production]
changed: [staging]

PLAY RECAP *********************************************************************
production                 : ok=3    changed=2    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0
staging                    : ok=3    changed=2    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="installapp"><a class="anchor" href="#installapp"></a>Installing the Application</h3>
<div class="paragraph">
<p>The following phase is copying the application to the <code>/var/hello</code> directory and configuring Supervisord to control the application process.</p>
</div>
<div class="paragraph">
<p>Before modifying the Playbook content, download <a href="https://github.com/redhat-scholars/ansible-tutorial/raw/master/apps/hello-simple/hello-world-1.0.0-SNAPSHOT-runner.jar" target="_blank" rel="noopener">Application</a> and <a href="https://github.com/redhat-scholars/ansible-tutorial/raw/master/apps/hello-simple/hello.conf" target="_blank" rel="noopener">Supervisord Configuration</a> and copy them in the same directory as playbook.</p>
</div>
<div class="paragraph">
<p>Append to the previous Playbook file, the following tasks:</p>
</div>
<div class="listingblock console-input">
<div class="title">playbook.yaml</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">    - name: Copy file with owner and permissions
      copy: <i class="conum" data-value="1"></i><b>(1)</b>
        src: hello-world-1.0.0-SNAPSHOT-runner.jar
        dest: /var/hello/hello-world-1.0.0-SNAPSHOT-runner.jar
        owner: root
        group: root
        mode: '0755'
      tags: ['app']
    - name: Copy supervisor conf file for the app
      copy: <i class="conum" data-value="2"></i><b>(2)</b>
        src: hello.conf
        dest: /etc/supervisord.d/hello.conf
        owner: root
        group: root
        mode: '0644'
      tags: ['app']
    - name: Reread supervisord
      command: /usr/bin/supervisorctl reread <i class="conum" data-value="3"></i><b>(3)</b>
      tags: ['app']
    - name: Update supervisord
      command: /usr/bin/supervisorctl update
      tags: ['app'] <i class="conum" data-value="4"></i><b>(4)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Copy module copies file from local directory to the remote machine</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Add supervisord configuration file</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Restart the supervisord daemon to load the configuration and start the application</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Tags section is used to categorize tasks</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The full playbook file should look like:</p>
</div>
<div class="listingblock console-input">
<div class="title">playbook.yaml</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">---
- hosts: all
  become: true
  tasks:
    - name: Install Packages
      dnf: name={{ item }}
      loop: [ 'java-17-openjdk-devel']
      tags: [ 'setup' ]
    - name: Create a directory if it does not exist
      file:
        path: /var/hello
        state: directory
        mode: '0755'
      tags: ['setup']
    - name: Copy file with owner and permissions
      copy:
        src: hello-world-1.0.0-SNAPSHOT-runner.jar
        dest: /var/hello/hello-world-1.0.0-SNAPSHOT-runner.jar
        owner: root
        group: root
        mode: '0755'
      tags: ['app']
    - name: Copy supervisor conf file for the app
      copy:
        src: hello.conf
        dest: /etc/supervisord.d/hello.conf
        owner: root
        group: root
        mode: '0644'
      tags: ['app']
    - name: Reread supervisord
      command: /usr/bin/supervisorctl reread
      tags: ['app']
    - name: Update supervisord
      command: /usr/bin/supervisorctl update
      tags: ['app']</code></pre>
</div>
</div>
<div class="paragraph">
<p>To apply a playbook, run the following command:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">ansible-playbook -i inventory playbook.yaml</code></pre>
</div>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-terminal hljs" data-lang="terminal">[WARNING]: Found both group and host with same name: production
[WARNING]: Found both group and host with same name: staging

PLAY [all] *********************************************************************

TASK [Gathering Facts] *********************************************************
ok: [staging]
ok: [production]

TASK [Install Packages] ********************************************************
ok: [staging] =&gt; (item=java-17-openjdk-devel)
ok: [production] =&gt; (item=java-17-openjdk-devel)

TASK [Create a directory if it does not exist] *********************************
ok: [staging]
ok: [production]

TASK [Copy file with owner and permissions] ************************************
changed: [staging]
changed: [production]

TASK [Copy supervisor conf file for the app] ***********************************
changed: [staging]
changed: [production]

TASK [Reread supervisord] ******************************************************
changed: [production]
changed: [staging]

TASK [Update supervisord] ******************************************************
changed: [staging]
changed: [production]

PLAY RECAP *********************************************************************
production                 : ok=7    changed=4    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0
staging                    : ok=7    changed=4    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0</code></pre>
</div>
</div>
<div class="paragraph">
<p>At this point, the steps executed in the previous section are not executed anymore, and the application is installed and running.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s query both applications (staging and production) to validate that application is working correctly:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">curl localhost:8080/hello <i class="conum" data-value="1"></i><b>(1)</b>
curl localhost:8081/hello <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Staging</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Production</td>
</tr>
</table>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-terminal hljs" data-lang="terminal">Hello from RESTEasy Reactive
Hello from RESTEasy Reactive</code></pre>
</div>
</div>
<div class="paragraph">
<p>Inspect the logs in the <em>docker-machine</em> terminal to validate that the process has been spawned by supervisord.</p>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-terminal hljs" data-lang="terminal">preprod_1  | 2023-01-27 15:26:04,952 INFO spawned: 'hello' with pid 1464
prod_1     | 2023-01-27 15:26:04,969 INFO spawned: 'hello' with pid 1463
preprod_1  | 2023-01-27 15:26:05,955 INFO success: hello entered RUNNING state, process has stayed up for &gt; than 1 seconds (startsecs)
prod_1     | 2023-01-27 15:26:05,972 INFO success: hello entered RUNNING state, process has stayed up for &gt; than 1 seconds (startsecs)
prod_1     | 2023-01-27 15:27:05,360 INFO reaped unknown pid 761 (exit status 255)
preprod_1  | 2023-01-27 15:27:05,469 INFO reaped unknown pid 762 (exit status 255)</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="validating"><a class="anchor" href="#validating"></a>Automatic Validation</h3>
<div class="paragraph">
<p>We validated the correctness of the deployment manually, but Ansible also supports this use case.</p>
</div>
<div class="listingblock console-input">
<div class="title">playbook.yaml</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">    - name: Check status 200 and fail if incorrect page contents
      uri: <i class="conum" data-value="1"></i><b>(1)</b>
        url: <a href="http://localhost:8080/hello" class="bare">http://localhost:8080/hello</a>
        return_content: yes
      register: response <i class="conum" data-value="2"></i><b>(2)</b>
      tags: ['test']
    - name: Print result
      debug:
        var: response.content <i class="conum" data-value="3"></i><b>(3)</b>
      tags: ['test']</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Use the <code>uri</code> module to query service</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Record return content into <code>response</code> variable</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Use the <code>debug</code> module to print the content of <code>response</code> variable (output)</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The full playbook file should look like:</p>
</div>
<div class="listingblock console-input">
<div class="title">playbook.yaml</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">---
- hosts: all
  become: true
  tasks:
    - name: Install Packages
      dnf: name={{ item }}
      loop: [ 'java-17-openjdk-devel']
      tags: [ 'setup' ]
    - name: Create a directory if it does not exist
      file:
        path: /var/hello
        state: directory
        mode: '0755'
      tags: ['setup']
    - name: Copy file with owner and permissions
      copy:
        src: hello-world-1.0.0-SNAPSHOT-runner.jar
        dest: /var/hello/hello-world-1.0.0-SNAPSHOT-runner.jar
        owner: root
        group: root
        mode: '0755'
      tags: ['app']
    - name: Copy supervisor conf file for the app
      copy:
        src: hello.conf
        dest: /etc/supervisord.d/hello.conf
        owner: root
        group: root
        mode: '0644'
      tags: ['app']
    - name: Reread supervisord
      command: /usr/bin/supervisorctl reread
      tags: ['app']
    - name: Update supervisord
      command: /usr/bin/supervisorctl update
      tags: ['app']
    - name: Check status 200 and fail if incorrect page contents
      uri:
        url: <a href="http://localhost:8080/hello" class="bare">http://localhost:8080/hello</a>
        return_content: yes
      register: response
      tags: ['test']
    - name: Print result
      debug:
        var: response.content
      tags: ['test']</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can run all the Ansible Playbook or restrict to only run the <code>test</code> tasks:</p>
</div>
<div class="listingblock console-input">
<div class="title">playbook.yaml</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">ansible-playbook -i inventory playbook.yaml --tags=test</code></pre>
</div>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-terminal hljs" data-lang="terminal">[WARNING]: Found both group and host with same name: staging
[WARNING]: Found both group and host with same name: production

PLAY [all] *********************************************************************

TASK [Gathering Facts] *********************************************************
ok: [production]
ok: [staging]

TASK [Check status 200 and fail if incorrect page contents] ********************
ok: [production]
ok: [staging]

TASK [Print result] ************************************************************
ok: [staging] =&gt; {
    "response.content": "Hello from RESTEasy Reactive"
}
ok: [production] =&gt; {
    "response.content": "Hello from RESTEasy Reactive"
}

PLAY RECAP *********************************************************************
production                 : ok=3    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0
staging                    : ok=3    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0</code></pre>
</div>
</div>
</div>
</div>
</div>
<nav class="pagination">
  <span class="prev"><a href="01-setup.html#prerequisite">Prerequisites</a></span>
  <span class="next"><a href="03-advanced.html">2. Templates</a></span>
</nav>
</article>
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
  </div>
</main>
</div>
<footer class="footer">
  <a class="rhd-logo" href="https://developers.redhat.com" target="_blank"></div>
</footer>
<script src="../_/js/vendor/clipboard.js"></script>
<script src="../_/js/site.js"></script>
<script async src="../_/js/vendor/highlight.js"></script>
  </body>
</html>
